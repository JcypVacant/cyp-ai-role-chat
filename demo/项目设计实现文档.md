### 项目设计实现文档

#### 一、技术栈选择

##### 1.后端技术栈

Java 21 + Spring Boot 3 + Mybatis-Plus + Redis + COS + 百度云ASR + 百度云TTS + langchain4j框架

##### 2.前端技术栈

Vue3 + TypeScript + Router + Axios + Pinia + Ant-design-vue

##### 3.数据库设计

用户表：

```sql
-- 创建库
create database if not exists cyp_ai_role_chat;

-- 切换库
use cyp_ai_role_chat;


-- 以下是建表语句
-- 用户表
create table if not exists user
(
    id           bigint auto_increment comment 'id' primary key,
    userAccount  varchar(256)                           not null comment '账号',
    userPassword varchar(512)                           not null comment '密码',
    userName     varchar(256)                           null comment '用户昵称',
    userAvatar   varchar(1024)                          null comment '用户头像',
    userProfile  varchar(512)                           null comment '用户简介',
    userRole     varchar(256) default 'user'            not null comment '用户角色：user/admin',
    editTime     datetime     default CURRENT_TIMESTAMP not null comment '编辑时间',
    createTime   datetime     default CURRENT_TIMESTAMP not null comment '创建时间',
    updateTime   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment '更新时间',
    isDelete     tinyint      default 0                 not null comment '是否删除',
    UNIQUE KEY uk_userAccount (userAccount),
    INDEX idx_userName (userName)
) comment '用户' collate = utf8mb4_unicode_ci;

```

角色表：

```sql
-- 角色表
create table role
(
    id           bigint auto_increment comment 'id' primary key,
    roleName     varchar(256)                       not null comment '角色名称（如哈利波特、苏格拉底）',
    cover        varchar(512)                       null comment '角色头像/封面URL',
    description  text                               null comment '角色简介（背景、性格等）',
    systemPrompt text                               not null comment '角色系统提示词（定义角色行为、语气、知识范围）',
    category     varchar(64)                        null comment '角色分类（如文学、历史、影视、虚拟等）',
    ttsVoice     varchar(64)                        null comment '百度云TTS发音人（用于语音合成，如"zhitian"、"siqi"）',
    priority     int      default 0                 not null comment '角色优先级（用于排序，数值越高越靠前）',
    userId       bigint                             not null comment '创建者id（0表示系统预设角色）',
    editTime     datetime default CURRENT_TIMESTAMP not null comment '最后编辑时间',
    createTime   datetime default CURRENT_TIMESTAMP not null comment '创建时间',
    updateTime   datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment '更新时间',
    isDelete     tinyint  default 0                 not null comment '是否删除（0-未删除，1-已删除）',
    INDEX idx_roleName (roleName),         -- 提升角色名称搜索性能
    INDEX idx_category (category),         -- 提升按分类筛选性能
    INDEX idx_userId (userId)              -- 提升查询用户创建角色的性能
) comment 'AI角色扮演信息表' collate = utf8mb4_unicode_ci;
```

对话历史表：

```sql
-- 对话历史表（适配“多用户→单角色”聊天场景，优化索引）
create table chat_history
(
    id            bigint auto_increment comment '主键id' primary key,
    message       text                               not null comment '消息内容（文本/语音转文本等）',
    messageType   varchar(32)                        not null comment '消息来源类型：user/ai',
    messageFormat varchar(32) default 'text'         not null comment '消息格式：text/voice',
    voiceUrl      varchar(1024)                      null comment '语音消息的云端存储URL（如果消息格式为voice）',
    roleId        bigint                             not null comment '所属角色id（多用户→单角色的核心关联）',
    userId        bigint                             not null comment '创建用户id（区分同一角色下的不同用户）',
    createTime    datetime    default CURRENT_TIMESTAMP not null comment '创建时间（排序核心字段）',
    updateTime    datetime    default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment '更新时间',
    isDelete      tinyint     default 0               not null comment '是否删除（0-未删，1-已删）',
    INDEX idx_roleId (roleId),                         -- 提升基于角色的查询性能
    INDEX idx_createTime (createTime),                 -- 提升基于时间的查询性能
    INDEX idx_roleId_createTime (roleId, createTime)   -- 游标查询核心索引
) comment '角色对话历史表（支持多用户与单角色聊天，适配文本/语音消息）' collate = utf8mb4_unicode_ci;
```



#### 二、实现功能

##### 1.用户模块(前后端)

实现的功能包括用户注册、用户登录、获取当前登录用户、用户注销、用户权限控制、【管理员】管理用户

##### 2.角色模块

**前端：**实现角色的主页面卡片显示，按名称角色搜索功能、加载对话历史功能

![image-20250928170226231](C:\Users\Jcyp\AppData\Roaming\Typora\typora-user-images\image-20250928170226231.png)



![image-20250928170335923](C:\Users\Jcyp\AppData\Roaming\Typora\typora-user-images\image-20250928170335923.png)

**后端：**接入deepseek大模型，接入百度云语音Asr和Tts服务，接入腾讯云COS，支持对话历史持久化存储、对话记忆功能

用户头像、角色头像封面、语音文件上传到腾讯云COS，数据库存URL。利用Redis缓存角色信息，包括Prompt词等。

#### 三、项目运行

前端执行以下命令：

```java
npm install
```

后端使用IDEA导入项目安装依赖即可。
